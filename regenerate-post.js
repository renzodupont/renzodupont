/**
 * Regenerate/Improve Existing Post
 *
 * Analyzes an existing post and rewrites it to be more resourceful and persuasive
 * with updated information, better sources, and stronger argumentation.
 *
 * Usage:
 *   node regenerate-post.js "path/to/post.html"
 *   node regenerate-post.js "public/posts/2025/10/crisis-economica.html"
 */

import { GoogleGenerativeAI } from "@google/generative-ai";
import * as fs from "node:fs";
import path from "path";
import dotenv from "dotenv";
import { fileURLToPath } from "url";
import { dirname } from "path";
import { JSDOM } from "jsdom";

dotenv.config();

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY);

/**
 * Extract article content from HTML file
 */
function extractArticleContent(htmlPath) {
  if (!fs.existsSync(htmlPath)) {
    throw new Error(`File not found: ${htmlPath}`);
  }

  const html = fs.readFileSync(htmlPath, "utf-8");
  const dom = new JSDOM(html);
  const doc = dom.window.document;

  // Extract title
  const title = doc.querySelector("h1")?.textContent || "Sin t√≠tulo";

  // Extract article content
  const articleContent =
    doc.querySelector(".article-content")?.innerHTML ||
    doc.querySelector("article")?.innerHTML ||
    "";

  // Extract metadata
  const metaDesc = doc.querySelector('meta[name="description"]')?.content || "";
  const date = doc.querySelector('meta[name="date"]')?.content || "";

  return {
    title,
    articleContent,
    metaDesc,
    date,
    fullHTML: html,
  };
}

/**
 * Create system prompt for regeneration
 */
function createRegenerationSystemPrompt() {
  return `Eres un divulgador experto especializado en explicar temas complejos de forma clara y accesible para P√öBLICO GENERAL sin conocimientos t√©cnicos previos.

Tu tarea es MEJORAR un art√≠culo existente para hacerlo M√ÅS CONCISO, mejor documentado, m√°s estructurado y m√°s efectivo para usuarios finales.

AUDIENCIA: Personas comunes y corrientes que quieren entender el tema sin tener conocimientos previos.

PRINCIPIOS CLAVE:
1. **Idioma**: TODO en ESPA√ëOL para Uruguay y Latinoam√©rica
2. **CONCISO Y DIRECTO**: Art√≠culos de 1000-1500 palabras m√°ximo - sin relleno
3. **Lenguaje Simple**: Explica como si hablaras con alguien sin formaci√≥n t√©cnica
4. **Estructura Clara**: 4-6 secciones H2 con 2-3 subsecciones H3 cada una
5. **Fuentes Actuales**: 5-8 fuentes confiables recientes (2024-2025)
6. **Ejemplos Cotidianos**: Analog√≠as y casos reales que todos entiendan
7. **Contexto Local**: Enfoque en Uruguay/Latinoam√©rica cuando sea relevante
8. **Pr√°ctico y √ötil**: Qu√© significa para el lector y qu√© puede hacer

ESTRUCTURA DEL ART√çCULO MEJORADO:
- Introducci√≥n gancho (1 p√°rrafo corto)
- ¬øPor qu√© me debe importar? (H2 - 2-3 p√°rrafos)
- MIT, Stanford, Harvard
- Universidades latinoamericanas reconocidas
- Revistas cient√≠ficas peer-reviewed

**Datos y Estad√≠sticas Oficiales:**
- Instituto Nacional de Estad√≠stica (INE - Uruguay)
- INDEC (Argentina)
- Pew Research Center
- Statista, Our World in Data
- Datos.gob.uy (datos abiertos Uruguay)

**Fact-Checkers y Verificaci√≥n:**
- AFP Factual
- Chequeado (Argentina)
- Maldita.es (Espa√±a)
- FactCheck.org, Snopes
- Observatorio de Noticias Falsas (Uruguay)

**Think Tanks y An√°lisis:**
- Brookings Institution
- Carnegie Endowment
- Freedom House
- Transparencia Internacional

MEJORAS A IMPLEMENTAR:

1. **M√°s Subt√≠tulos y Estructura**:
   - 5-7 secciones principales (H2) m√≠nimo
   - 3-4 subsecciones (H3) por cada H2
   - Total de 15-25 subt√≠tulos en el art√≠culo
   - Un nuevo subt√≠tulo cada 2-3 p√°rrafos

2. **Lenguaje M√°s Accesible**:
   - Eliminar jerga t√©cnica innecesaria
   - Explicar conceptos complejos con analog√≠as cotidianas
   - Usar "t√∫" o "vos" para conectar con el lector
   - Preguntas ret√≥ricas para mantener inter√©s

3. **M√°s Fuentes Actuales**:
   - Al menos 10-15 fuentes mencionadas por nombre
   - Priorizar fuentes de 2024-2025
   - Incluir estudios, informes, art√≠culos espec√≠ficos
   - Contextualizar cada fuente brevemente

4. **Ejemplos y Casos Reales**:
   - Historias concretas de Uruguay/Latinoam√©rica
- Conceptos clave (H2 con 2-3 H3)
- Secciones principales (2-3 H2, cada una con 2-3 H3)
- Consejos pr√°cticos (H2 con 2-3 H3)
- Conclusi√≥n pr√°ctica (H2 - OBLIGATORIA, 2-3 p√°rrafos)

TONO: Conversacional, cercano pero informativo. Usa "t√∫" o "vos".

FUENTES CONFIABLES (2024-2025):
- Medios: MIT Tech Review, BBC Mundo, The Verge, El Observador, La Diaria
- Organizaciones: ONU, OMS, CEPAL, EFF, UNESCO, Banco Mundial
- Estudios: Nature, Science, Pew Research
- Fact-checkers: AFP Factual, Chequeado
- Datos oficiales: INE (Uruguay), Statista

FORMATO HTML:
- <h2> secciones principales (4-6)
- <h3> subsecciones (8-15 total)
- <p> p√°rrafos cortos
- <ul>/<ol> para listas
- <blockquote> para datos clave
- <strong> para puntos cr√≠ticos
- <a href="#"> para fuentes

‚ö†Ô∏è IMPORTANTE:
- M√ÅXIMO 1500 palabras - s√© CONCISO
- Elimina relleno y repeticiones
- Cada p√°rrafo debe aportar valor
- La CONCLUSI√ìN es OBLIGATORIA (2-3 p√°rrafos)
- El art√≠culo DEBE terminar COMPLETO con punto final

TODO EN ESPA√ëOL.
Enfoque Uruguay/Latinoam√©rica cuando sea relevante.

FORMATO: 
Retorna SOLO el contenido HTML del art√≠culo (lo que va dentro de <div class="article-content">).
NO incluyas <!DOCTYPE>, <html>, <head>, <body>, ni navegaci√≥n.
NO incluyas la imagen destacada.

Comienza con un p√°rrafo gancho que enganche al lector.

COMIENZA EL ART√çCULO MEJORADO AHORA:`;
}

/**
 * Create user prompt for improving content
 */
function createImprovementPrompt(originalTitle, originalContent) {
  return `Analiza y MEJORA este art√≠culo para hacerlo M√ÅS CONCISO, CLARO y ACCESIBLE para p√∫blico general:

T√çTULO ORIGINAL: ${originalTitle}

CONTENIDO ORIGINAL:
${originalContent}

Tu tarea:
1. ANALIZA el tema y identifica qu√© es esencial y qu√© es relleno
2. REESCRIBE completamente el art√≠culo para:
   - REDUCIR a 1000-1500 palabras M√ÅXIMO (elimina relleno y repetici√≥n)
   - Usar LENGUAJE SIMPLE Y DIRECTO (sin jerga innecesaria)
   - Agregar subt√≠tulos claros: 4-6 H2, cada uno con 2-3 H3
   - Explicar conceptos con ANALOG√çAS SIMPLES
   - Incluir EJEMPLOS BREVES de Uruguay/LATAM cuando sea relevante
   - Agregar CONSEJOS PR√ÅCTICOS concretos
   - Incorporar 5-8 FUENTES ACTUALES (2024-2025) mencionadas por nombre
   - Estructura visual: listas, blockquotes, negritas

REQUISITOS CR√çTICOS:

**Estructura Clara y Concisa:**
- 4-6 secciones principales (H2)
- 2-3 subsecciones (H3) por cada H2
- Un nuevo subt√≠tulo cada 2-3 p√°rrafos
- Total: 8-15 subt√≠tulos en el art√≠culo

**Lenguaje Accesible:**
- Explica de forma SIMPLE y DIRECTA
- Usa "t√∫" o "vos"
- Evita: jerga, tecnicismos innecesarios, relleno, repeticiones
- Prefiere: analog√≠as breves, ejemplos concretos, lenguaje conversacional

**Fuentes Actuales (2024-2025):**
Incluir 5-8 fuentes mencionadas por nombre:
- Medios: MIT Tech Review, BBC Mundo, The Verge, El Observador, La Diaria
- Organizaciones: ONU, OMS, CEPAL, EFF, UNESCO
- Estudios: Nature, Science, Pew Research
- Fact-checkers: AFP Factual, Chequeado
- Datos oficiales: INE (Uruguay), Statista

**Contexto Local (cuando sea relevante):**
- Ejemplos breves de Uruguay/Argentina/Latinoam√©rica
- Datos estad√≠sticos regionales actualizados
- Referencias a situaciones locales reconocibles

**Formato HTML Mejorado:**
- <h2> secciones principales (5-7)
- <h3> subsecciones frecuentes (15-25 total)
- <p> p√°rrafos cortos (3-4 l√≠neas)
- <ul>/<ol> para listas y pasos
- <blockquote> para datos clave o citas importantes
- <strong> para destacar puntos cr√≠ticos
**Contenido Pr√°ctico:**
- Secci√≥n "¬øPor qu√© me debe importar?" (2-3 p√°rrafos)
- Secci√≥n "Consejos pr√°cticos: Qu√© puedes hacer t√∫" (H2 con 2-3 H3)
- Conclusi√≥n obligatoria (H2 - 2-3 p√°rrafos completos)

‚ö†Ô∏è CR√çTICO:
- M√ÅXIMO 1500 palabras - elimina TODO el relleno
- Art√≠culo DEBE terminar COMPLETO con punto final
- Conclusi√≥n OBLIGATORIA con 2-3 p√°rrafos
- NO dejes frases incompletas
- Cada p√°rrafo debe aportar valor real

TODO EN ESPA√ëOL. 
Enfoque Uruguay/Latinoam√©rica cuando sea relevante.
Prioriza CLARIDAD y BREVEDAD.

FORMATO: 
Retorna SOLO el contenido HTML del art√≠culo (lo que va dentro de <div class="article-content">).
NO incluyas <!DOCTYPE>, <html>, <head>, <body>, ni navegaci√≥n.
NO incluyas la imagen destacada.

Comienza con un p√°rrafo gancho breve.

COMIENZA EL ART√çCULO MEJORADO Y CONCISO AHORA:`;
}

/**
 * Regenerate article content
 */
async function regenerateArticle(htmlPath) {
  console.log("\n" + "‚ïê".repeat(70));
  console.log("üîÑ REGENERACI√ìN DE ART√çCULO");
  console.log("‚ïê".repeat(70));

  // Extract existing content
  console.log("\nüìñ Leyendo art√≠culo existente...");
  const existing = extractArticleContent(htmlPath);
  console.log(`‚úÖ T√≠tulo: ${existing.title}`);
  console.log(`‚úÖ Contenido: ${existing.articleContent.length} caracteres\n`);

  // Generate improved content
  console.log("ü§ñ Generando versi√≥n mejorada con Gemini 1.5 Pro...");
  console.log("   ‚Üí Analizando tema y contexto");
  console.log("   ‚Üí Buscando informaci√≥n actualizada");
  console.log("   ‚Üí Mejorando argumentaci√≥n y fuentes\n");

  const model = genAI.getGenerativeModel({
    model: "gemini-2.5-flash",
    systemInstruction: createRegenerationSystemPrompt(),
  });

  const prompt = createImprovementPrompt(
    existing.title,
    existing.articleContent
  );

  try {
    const result = await model.generateContent(prompt);
    const improvedContent = result.response.text();

    console.log(
      `‚úÖ Contenido mejorado generado: ${improvedContent.length} caracteres`
    );

    // Generate new metadata
    console.log("\nüìù Generando metadatos actualizados...");
    const metadata = await generateMetadata(improvedContent, existing.title);
    console.log(`‚úÖ T√≠tulo optimizado: ${metadata.title}`);

    // Replace content in HTML (no backup - direct overwrite)
    console.log("\nÔøΩ Actualizando archivo HTML...");
    const dom = new JSDOM(existing.fullHTML);
    const doc = dom.window.document;

    // Update title
    const h1 = doc.querySelector("h1");
    if (h1) h1.textContent = metadata.title;

    const titleTag = doc.querySelector("title");
    if (titleTag) titleTag.textContent = `${metadata.title} | Renzo Dupont`;

    // Update meta description
    const metaDesc = doc.querySelector('meta[name="description"]');
    if (metaDesc) metaDesc.content = metadata.description;

    // Update article content
    const articleContentDiv = doc.querySelector(".article-content");
    if (articleContentDiv) {
      articleContentDiv.innerHTML = improvedContent;
    }

    // Update date
    const metaDate = doc.querySelector('meta[name="date"]');
    if (metaDate) metaDate.content = new Date().toISOString();

    const dateDisplay = doc.querySelector(".article-meta");
    if (dateDisplay) {
      dateDisplay.textContent = `Actualizado el ${new Date().toLocaleDateString(
        "es-ES",
        {
          year: "numeric",
          month: "long",
          day: "numeric",
        }
      )}`;
    }

    // Save updated file
    fs.writeFileSync(htmlPath, dom.serialize());
    console.log(`\n‚úÖ Art√≠culo actualizado: ${htmlPath}`);

    // Update posts database
    await updatePostInDatabase(htmlPath, metadata);

    console.log("\n" + "‚ïê".repeat(70));
    console.log("‚úÖ REGENERACI√ìN COMPLETADA");
    console.log("‚ïê".repeat(70));
    console.log(`\nüìÑ Archivo actualizado: ${htmlPath}`);
    console.log(`üíæ Backup disponible: ${backupPath}`);
    console.log(
      `\nüìù Pr√≥ximos pasos:\n   1. Revisa el art√≠culo mejorado\n   2. git add ${htmlPath}\n   3. git commit -m "Mejorar: ${metadata.title}"\n   4. git push origin main\n`
    );

    return {
      success: true,
      filePath: htmlPath,
      backupPath,
      metadata,
    };
  } catch (error) {
    console.error("\n‚ùå Error al regenerar art√≠culo:", error.message);
    throw error;
  }
}

/**
 * Generate metadata from content
 */
async function generateMetadata(htmlContent, originalTitle) {
  const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash" });

  const prompt = `Analiza este art√≠culo en espa√±ol y genera metadatos en formato JSON:

Art√≠culo:
${htmlContent.substring(0, 3000)}...

Retorna un objeto JSON con:
{
  "title": "T√≠tulo CLARO, ATRACTIVO y ACCESIBLE para p√∫blico general (50-90 caracteres)",
  "excerpt": "Resumen breve (150-200 caracteres) que enganche sin jerga t√©cnica",
  "description": "Meta descripci√≥n SEO (140-160 caracteres, lenguaje simple)",
  "tags": ["etiqueta1", "etiqueta2", "etiqueta3"]
}

REGLAS PARA EL T√çTULO (ORIENTADO A P√öBLICO GENERAL):
- Usar LENGUAJE SIMPLE Y CLARO (sin tecnicismos innecesarios)
- Incluir BENEFICIO o RELEVANCIA ("C√≥mo...", "Por qu√©...", "Lo que debes saber...")
- Generar INTER√âS sin clickbait
- Ser ESPEC√çFICO y DESCRIPTIVO
- 50-90 caracteres ideal
- TODO EN ESPA√ëOL

EJEMPLOS DE BUENOS T√çTULOS:
‚ùå MAL (t√©cnico): "Algoritmos de IA en Redes Sociales"
‚úÖ BIEN (accesible): "C√≥mo las Redes Sociales Deciden Qu√© Ves (y Por Qu√© Importa)"

‚ùå MAL (gen√©rico): "Problemas econ√≥micos"
‚úÖ BIEN (espec√≠fico): "7 Se√±ales de Crisis Econ√≥mica que Afectan tu Bolsillo"

‚ùå MAL (aburrido): "Informaci√≥n sobre privacidad"
‚úÖ BIEN (interesante): "Tu Tel√©fono Te Esp√≠a: C√≥mo Proteger tu Privacidad en 2025"

Las etiquetas deben ser accesibles en espa√±ol (tecnolog√≠a, privacidad, consejos, seguridad online, vida cotidiana, Uruguay, Latinoam√©rica, etc.)

Retorna SOLO JSON v√°lido, nada m√°s.`;

  const result = await model.generateContent(prompt);
  const response = result.response.text();

  const jsonMatch = response.match(/\{[\s\S]*\}/);
  if (!jsonMatch) {
    throw new Error("No se pudo extraer JSON de la respuesta");
  }

  return JSON.parse(jsonMatch[0]);
}

/**
 * Update post in database
 */
async function updatePostInDatabase(htmlPath, metadata) {
  const dbPath = path.join(__dirname, "posts-database.json");

  if (!fs.existsSync(dbPath)) {
    console.log("‚ö†Ô∏è  posts-database.json no encontrado");
    return;
  }

  const db = JSON.parse(fs.readFileSync(dbPath, "utf-8"));

  // Find post by path
  const relativePath = htmlPath.replace(/^.*\/public/, "");
  const postIndex = db.posts.findIndex((p) => p.link === relativePath);

  if (postIndex >= 0) {
    // Update existing post
    db.posts[postIndex].title = metadata.title;
    db.posts[postIndex].excerpt = metadata.excerpt;
    db.posts[postIndex].tags = metadata.tags;
    db.posts[postIndex].date = new Date().toISOString();

    fs.writeFileSync(dbPath, JSON.stringify(db, null, 2));
    console.log("‚úÖ Base de datos actualizada");
  } else {
    console.log("‚ö†Ô∏è  Post no encontrado en la base de datos");
  }
}

/**
 * Find all HTML posts in the public/posts directory
 */
function findAllPosts() {
  const postsDir = path.join(__dirname, "public", "posts");
  const posts = [];

  function scanDirectory(dir) {
    if (!fs.existsSync(dir)) return;

    const items = fs.readdirSync(dir);

    for (const item of items) {
      const fullPath = path.join(dir, item);
      const stat = fs.statSync(fullPath);

      if (stat.isDirectory()) {
        scanDirectory(fullPath);
      } else if (item.endsWith(".html") && !item.endsWith(".backup.html")) {
        posts.push(fullPath);
      }
    }
  }

  scanDirectory(postsDir);
  return posts;
}

/**
 * Regenerate all posts
 */
async function regenerateAllPosts() {
  console.log("\n" + "‚ïê".repeat(70));
  console.log("üîÑ REGENERACI√ìN MASIVA DE ART√çCULOS");
  console.log("‚ïê".repeat(70));

  const posts = findAllPosts();

  if (posts.length === 0) {
    console.log("\n‚ö†Ô∏è  No se encontraron posts en public/posts/");
    return;
  }

  console.log(`\nüìö Se encontraron ${posts.length} art√≠culos para regenerar\n`);

  const results = {
    successful: [],
    failed: [],
    skipped: [],
  };

  for (let i = 0; i < posts.length; i++) {
    const post = posts[i];
    const relativePath = post.replace(__dirname + "/", "");

    console.log(`\n[$${i + 1}/${posts.length}] Procesando: ${relativePath}`);
    console.log("-".repeat(70));

    try {
      await regenerateArticle(post);
      results.successful.push(relativePath);
      console.log(`‚úÖ Completado: ${relativePath}`);

      // Small delay between posts to avoid rate limiting
      if (i < posts.length - 1) {
        console.log("\n‚è≥ Esperando 5 segundos antes del siguiente...");
        await new Promise((resolve) => setTimeout(resolve, 5000));
      }
    } catch (error) {
      console.error(`\n‚ùå Error en ${relativePath}: ${error.message}`);
      results.failed.push({ path: relativePath, error: error.message });
    }
  }

  // Final summary
  console.log("\n" + "‚ïê".repeat(70));
  console.log("üìä RESUMEN DE REGENERACI√ìN");
  console.log("‚ïê".repeat(70));
  console.log(`\n‚úÖ Exitosos: ${results.successful.length}`);
  console.log(`‚ùå Fallidos: ${results.failed.length}`);
  console.log(`‚è≠Ô∏è  Omitidos: ${results.skipped.length}`);
  console.log(`üìù Total: ${posts.length}`);

  if (results.successful.length > 0) {
    console.log("\n‚úÖ Art√≠culos regenerados exitosamente:");
    results.successful.forEach((path) => console.log(`   - ${path}`));
  }

  if (results.failed.length > 0) {
    console.log("\n‚ùå Art√≠culos con errores:");
    results.failed.forEach((item) =>
      console.log(`   - ${item.path}: ${item.error}`)
    );
  }

  console.log("\n" + "‚ïê".repeat(70));
  console.log(
    `\nüìù Pr√≥ximos pasos:\n   1. Revisa los art√≠culos regenerados\n   2. git add .\n   3. git commit -m "Regenerate all posts with updated sources"\n   4. git push origin main\n`
  );

  return results;
}

/**
 * Main execution
 */
async function main() {
  const args = process.argv.slice(2);

  if (args.length === 0 || args.includes("--help") || args.includes("-h")) {
    console.log(`
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë              üîÑ REGENERADOR DE ART√çCULOS                              ‚ïë
‚ïë       Mejora art√≠culos existentes con fuentes actualizadas           ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

Uso:
  node regenerate-post.js <ruta-al-archivo-html>
  node regenerate-post.js --all

Ejemplos:
  # Mejorar un art√≠culo espec√≠fico
  node regenerate-post.js "public/posts/2025/10/crisis-economica.html"

  # Mejorar TODOS los art√≠culos
  node regenerate-post.js --all
  npm run regenerate-post --all

Caracter√≠sticas:
  ‚úÖ Reescribe el art√≠culo con m√°s fuentes confiables
  ‚úÖ Prioriza informaci√≥n reciente (2024-2025)
  ‚úÖ Todo en espa√±ol para mercado uruguayo
  ‚úÖ Argumentaci√≥n m√°s persuasiva
  ‚úÖ Crea backup autom√°tico del original
  ‚úÖ Actualiza la base de datos

Modo --all:
  ‚ö° Procesa todos los posts en public/posts/
  üîÑ Espera 5 segundos entre posts (evitar rate limiting)
  üíæ Crea backup de cada archivo
  üìä Muestra resumen final

Requisitos:
  ‚Ä¢ GEMINI_API_KEY en archivo .env

Obt√©n la clave: https://aistudio.google.com/app/apikey
`);
    process.exit(0);
  }

  // Check for API key
  if (!process.env.GEMINI_API_KEY) {
    console.error("‚ùå Error: GEMINI_API_KEY no encontrada en archivo .env");
    console.error("\nüìù Agrega a .env: GEMINI_API_KEY=tu_clave_aqui");
    console.error("   Obt√©n clave: https://aistudio.google.com/app/apikey");
    process.exit(1);
  }

  // Check for --all flag
  if (args.includes("--all")) {
    try {
      await regenerateAllPosts();
      process.exit(0);
    } catch (error) {
      console.error("\n‚ùå Error en regeneraci√≥n masiva:", error.message);
      process.exit(1);
    }
  }

  const filePath = args[0];

  // Resolve path
  const fullPath = path.isAbsolute(filePath)
    ? filePath
    : path.join(__dirname, filePath);

  try {
    await regenerateArticle(fullPath);
    process.exit(0);
  } catch (error) {
    console.error("\n‚ùå Error:", error.message);
    process.exit(1);
  }
}

main();
